<div class="d-flex flex-column" style="height:calc(100vh - 80px)">

  <!-- Messages -->
  <div class="messages-container flex-grow-1 overflow-auto px-4 py-4" #messagesContainer>

    <div *ngIf="messages.length === 0 && !isBotTyping && !isStreaming" class="h-100 d-flex flex-column align-items-center justify-content-center">
      <div style="font-size:48px;margin-bottom:1rem">&#129302;</div>
      <h5 style="color:var(--text-secondary);font-weight:600">Ready to help</h5>
      <p class="text-muted" style="font-size:14px;text-align:center;max-width:300px">
        Ask anything about the documents in this area.
      </p>
    </div>

    <div *ngFor="let message of messages"
         class="d-flex mb-3"
         [class.justify-content-end]="message.role === 'user'">

      <!-- Avatar -->
      <div *ngIf="message.role === 'assistant'"
           class="flex-shrink-0 me-3"
           style="width:32px;height:32px;border-radius:50%;background:var(--accent-subtle);border:1px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:16px;align-self:flex-end">
        &#129302;
      </div>

      <div style="max-width:72%">
        <div class="message-bubble"
             [class.message-user]="message.role === 'user'"
             [class.message-assistant]="message.role === 'assistant'">
          <div *ngIf="message.role === 'user'">{{ message.content }}</div>
          <div *ngIf="message.role === 'assistant'" [innerHTML]="(message.contentHtml || message.content) | safeHtml"></div>
        </div>

        <!-- Sources -->
        <div *ngIf="message.sources && message.sources.length > 0" class="mt-2">
          <details style="font-size:11px;color:var(--text-muted)">
            <summary style="cursor:pointer;user-select:none">Sources ({{ parseSources(message.sources).length }})</summary>
            <ul class="list-unstyled ms-2 mt-1" style="margin-bottom:0">
              <li *ngFor="let source of parseSources(message.sources)">
                <i class="bi bi-file-earmark me-1"></i>
                {{ source.documentName }}
                <span class="text-muted"> · chunk {{ source.chunkIndex }} · {{ source.similarity | number:'1.2-2' }}</span>
              </li>
            </ul>
          </details>
        </div>

        <div class="message-meta" [class.text-end]="message.role === 'user'">
          {{ message.createdAt | date:'HH:mm' }}
        </div>
      </div>

      <!-- User avatar -->
      <div *ngIf="message.role === 'user'"
           class="flex-shrink-0 ms-3"
           style="width:32px;height:32px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:13px;color:#fff;font-weight:600;align-self:flex-end">
        U
      </div>

    </div>

    <!-- Typing indicator -->
    <div *ngIf="isBotTyping" class="d-flex mb-3">
      <div class="flex-shrink-0 me-3"
           style="width:32px;height:32px;border-radius:50%;background:var(--accent-subtle);border:1px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:16px;align-self:flex-end">
        &#129302;
      </div>
      <div class="message-bubble message-assistant d-flex align-items-center" style="padding:.75rem 1rem">
        <div class="typing-indicator">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>

    <!-- Streaming message in progress -->
    <div *ngIf="isStreaming" class="d-flex mb-3">
      <div class="flex-shrink-0 me-3"
           style="width:32px;height:32px;border-radius:50%;background:var(--accent-subtle);border:1px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:16px;align-self:flex-end">
        &#129302;
      </div>
      <div style="max-width:72%">
        <div class="message-bubble message-assistant">{{ streamingContent }}<span class="cursor-blink">&#9608;</span></div>
        <div class="message-meta">typing…</div>
      </div>
    </div>

  </div>

  <!-- Input -->
  <div class="input-area px-4 py-3">
    <div class="d-flex gap-2 align-items-end">
      <textarea
        class="form-control flex-grow-1"
        rows="2"
        placeholder="Ask a question about your documents…"
        [(ngModel)]="newMessage"
        (keypress)="onKeyPress($event)"
        [disabled]="isBusy"
        style="resize:none;border-radius:var(--radius-md);padding:.65rem .9rem;"
      ></textarea>
      <button
        class="btn btn-primary"
        style="height:fit-content;padding:.65rem 1.25rem;border-radius:var(--radius-md)"
        (click)="sendMessage()"
        [disabled]="isBusy || !newMessage.trim()">
        <span *ngIf="isLoading" class="spinner-border spinner-border-sm" style="width:12px;height:12px;border-width:2px"></span>
        <span *ngIf="!isLoading"><i class="bi bi-send-fill"></i></span>
        <span *ngIf="isLoading">…</span>
      </button>
    </div>
  </div>

</div>
